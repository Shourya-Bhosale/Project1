<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Order - Shiv Organic Dairy Farm</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap">
    <link rel="stylesheet" href="{% static 'store/styles.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="container nav-flex">
            <div class="brand"><img class="logo" src="{% static 'store/images/Shiv Logo (1).png' %}" alt="Shiv Organic Dairy Farm" /> Shiv Organic Dairy Farm</div>
            <div class="links">
                <a href="/">Home</a>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <h2>Place Your Order</h2>
            <form method="post" class="order-form">
                {% csrf_token %}
                <input type="hidden" name="__from_home" value="1" />
                <div class="grid-2">
                    <div>
                        <label>Full Name</label>
                        {{ form.customer_name }}
                    </div>
                    <div>
                        <label>Email</label>
                        {{ form.email }}
                    </div>
                    <div>
                        <label>Phone</label>
                        {{ form.phone }}
                    </div>
                    <div>
                        <label>Address Line 1</label>
                        {{ form.address_line1 }}
                        <div class="muted"><a href="#" id="useMyLocation">Use my location</a> <span id="locTick" style="display:none">✅</span></div>
                    </div>
                    <div>
                        <label>Address Line 2 (Optional)</label>
                        {{ form.address_line2 }}
                    </div>
                    <div>
                        <label>City</label>
                        {{ form.city }}
                    </div>
                    <div>
                        <label>State</label>
                        {{ form.state }}
                    </div>
                    <div>
                        <label>Pincode</label>
                        {{ form.postal_code }}
                    </div>
                    <div class="full">
                        <label>Notes</label>
                        {{ form.notes }}
                    </div>
                    <div>
                        <label>Payment Method</label>
                        {{ form.payment_method }}
                        <div class="pay-helper" id="payHelper" style="display:none;margin-top:8px;">
                            <div id="qrWrap" class="qr">
                                <img src="{% static 'store/images/upi_qr.jpg' %}" alt="UPI QR" />
                                <div class="muted">Scan and pay (UPI). Enter last 6 digits in reference.</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label>Payment Reference (UPI last 6 / COD note)</label>
                        {{ form.payment_reference }}
                    </div>
                    {{ form.latitude }}
                    {{ form.longitude }}
                    <div class="muted" id="locStatus" style="display:none;align-self:center">✅ Location captured</div>
                </div>

                <h3>Your Cart</h3>
                <div class="cart">
                    {% for product in products %}
                    <div class="cart-row">
                        <div class="cart-info">
                            <img src="{{ product.image_url }}" alt="{{ product.name }}">
                            <div>
                                <strong>{{ product.name }}</strong>
                                <div class="muted">₹{{ product.price }}</div>
                            </div>
                        </div>
                        <div class="cart-qty">
                            <input type="number" name="qty_{{ product.id }}" value="0" min="0" data-size="{{ product.size_ml }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="pay-helper" id="payHelper" style="display:none;">
                    <div id="qrWrap" class="qr">
                        <img src="{% static 'store/images/upi_qr.jpg' %}" alt="UPI QR" />
                        <div class="muted">Scan and pay (UPI). Enter last 6 digits in reference.</div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" type="submit">Place Order</button>
                    <a class="btn btn-secondary" href="/">Cancel</a>
                </div>
            </form>
        </div>
    </section>
    <script>
        // Preselect product quantity from query param
        const params = new URLSearchParams(window.location.search);
        const prod = params.get('product'); // '250' | '500' | '1000'
        if (prod) {
            document.querySelectorAll('.cart-qty input[data-size]').forEach(function(inp){
                if (String(inp.getAttribute('data-size')) === String(prod)) {
                    inp.value = 1;
                }
            });
        }
        // Toggle QR only when UPI is selected
        const pmSelect = document.querySelector('[name="payment_method"]');
        const qrWrap = document.getElementById('qrWrap');
        const payHelper = document.getElementById('payHelper');
        function toggleQR(){
            if (!pmSelect || !qrWrap) return;
            const show = (pmSelect.value === 'UPI');
            qrWrap.style.display = show ? 'block' : 'none';
            if (payHelper) payHelper.style.display = show ? 'flex' : 'none';
        }
        pmSelect && pmSelect.addEventListener('change', toggleQR);
        toggleQR();

        // Ask location only when user interacts (e.g., when focusing address)
        const addressField = document.querySelector('[name="address_line1"]');
        const locStatus = document.getElementById('locStatus');
        const locTick = document.getElementById('locTick');
        const useMyLocation = document.getElementById('useMyLocation');
        function askGeo() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(function(pos){
                const lat = pos.coords.latitude.toFixed(6);
                const lng = pos.coords.longitude.toFixed(6);
                const latInput = document.querySelector('[name="latitude"]');
                const lngInput = document.querySelector('[name="longitude"]');
                if (latInput && !latInput.value) latInput.value = lat;
                if (lngInput && !lngInput.value) lngInput.value = lng;
                if (locStatus) locStatus.style.display = 'inline-block';
                if (locTick) locTick.style.display = 'inline-block';
            });
            addressField && addressField.removeEventListener('focus', askGeo);
        }
        addressField && addressField.addEventListener('focus', askGeo);

        // Manual trigger
        if (useMyLocation){
            useMyLocation.addEventListener('click', function(e){ e.preventDefault(); askGeo(); });
        }

        // Ensure location is captured before submit if possible
        const formEl = document.querySelector('form.order-form');
        if (formEl){
            formEl.addEventListener('submit', function(e){
                const latInput = document.querySelector('[name="latitude"]');
                const lngInput = document.querySelector('[name="longitude"]');
                const missing = !latInput.value || !lngInput.value;
                if (missing && navigator.geolocation){
                    e.preventDefault();
                    navigator.geolocation.getCurrentPosition(function(pos){
                        latInput.value = pos.coords.latitude.toFixed(6);
                        lngInput.value = pos.coords.longitude.toFixed(6);
                        if (locStatus) locStatus.style.display = 'inline-block';
                        if (locTick) locTick.style.display = 'inline-block';
                        formEl.submit();
                    }, function(){
                        formEl.submit();
                    });
                }
            });
        }
    </script>
</body>
</html>


