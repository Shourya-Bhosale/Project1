<!DOCTYPE html>
<html lang="en">
<head style="background-color:;">
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Order - Shiv Organic Dairy Farm</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap">
    <link rel="stylesheet" href="{% static 'store/styles.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="container nav-flex">
            <div class="brand"><img class="logo" src="{% static 'store/images/Shiv Logo (1).png' %}" alt="Shiv Organic Dairy Farm" /> Shiv Organic Dairy Farm</div>
            <div class="links">
                <a href="/">Home</a>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <h2>Place Your Order</h2>
            <form method="post" class="order-form">
                {% csrf_token %}
                <input type="hidden" name="__from_home" value="1" />
                <div class="grid-2">
                    <div>
                        <label>Full Name</label>
                        {{ form.customer_name }}
                    </div>
                    <div>
                        <label>Email</label>
                        {{ form.email }}
                    </div>
                    <div>
                        <label>Phone</label>
                        {{ form.phone }}
                    </div>
                    <div>
                        <label>Address Line 1</label>
                        {{ form.address_line1 }}
                        <div class="muted"><a href="#" id="useMyLocation">Use my location</a> <span id="locTick" style="display:none">âœ…</span></div>
                    </div>
                    <div>
                        <label>Address Line 2 (Optional)</label>
                        {{ form.address_line2 }}
                    </div>
                    <div>
                        <label>City</label>
                        {{ form.city }}
                    </div>
                    <div>
                        <label>State</label>
                        {{ form.state }}
                    </div>
                    <div>
                        <label>Pincode</label>
                        {{ form.postal_code }}
                    </div>
                    <div class="full">
                        <label>Order Instructions</label>
                        {{ form.notes }}
                        <div class="muted">Any special instructions for your order (optional)</div>
                    </div>
                    <div>
                        <label>Payment Method</label>
                        {{ form.payment_method }}
                    </div>
                    
                    <!-- UPI QR Scanner Section -->
                    <div class="upi-section" id="upiSection" style="display:none;">
                        <div class="qr-scanner">
                            <h4>ðŸ“± Scan UPI QR Code</h4>
                            <div class="qr-container">
                                <img src="{% static 'store/images/upi_qr.jpg' %}" alt="UPI QR Code" class="qr-image" />
                            </div>
                            <div class="qr-instructions">
                                <p>1. Open your UPI app (PhonePe, Google Pay, Paytm, etc.)</p>
                                <p>2. Scan this QR code</p>
                                <p>3. Enter the amount: <strong>â‚¹<span id="totalAmount">0</span></strong></p>
                                <p>4. Complete the payment</p>
                                <p>5. Enter the last 6 digits of transaction reference below</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label id="paymentRefLabel">Payment Reference</label>
                        {{ form.payment_reference }}
                        <div class="muted" id="paymentRefHelp">
                            <span id="upiHelp" style="display:none;">Enter last 6 digits of UPI transaction reference</span>
                            <span id="codHelp" style="display:none;">Enter any note for Cash on Delivery</span>
                        </div>
                    </div>
                    {{ form.latitude }}
                    {{ form.longitude }}
                    <div class="muted" id="locStatus" style="display:none;align-self:center">âœ… Location captured</div>
                </div>

                <h3>Your Cart</h3>
                <div class="cart">
                    {% for product in products %}
                    <div class="cart-row">
                        <div class="cart-info">
                            {% if product.size_ml == 250 %}
                                <img src="{% static 'store/images/250ml.png' %}" alt="{{ product.name }}">
                            {% elif product.size_ml == 500 %}
                                <img src="{% static 'store/images/500 Ml.png' %}" alt="{{ product.name }}">
                            {% elif product.size_ml == 1000 %}
                                <img src="{% static 'store/images/1000 Ml.png' %}" alt="{{ product.name }}">
                            {% else %}
                                <img src="{% static 'store/images/COW.png' %}" alt="{{ product.name }}">
                            {% endif %}
                            <div>
                                <strong>{{ product.name }}</strong>
                                <div class="muted">â‚¹{{ product.price }}</div>
                            </div>
                        </div>
                        <div class="cart-qty">
                            <input type="number" name="qty_{{ product.id }}" value="0" min="0" data-size="{{ product.size_ml }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>



                <div class="actions">
                    <button class="btn btn-primary" type="submit">Place Order</button>
                    <a class="btn btn-secondary" href="/">Cancel</a>
                </div>
            </form>
        </div>
    </section>
    <script>
        // Preselect product quantity from query param
        const params = new URLSearchParams(window.location.search);
        const prod = params.get('product'); // '250' | '500' | '1000'
        if (prod) {
            document.querySelectorAll('.cart-qty input[data-size]').forEach(function(inp){
                if (String(inp.getAttribute('data-size')) === String(prod)) {
                    inp.value = 1;
                }
            });
        }
        // Toggle UPI section and update payment reference label
        const pmSelect = document.querySelector('[name="payment_method"]');
        const upiSection = document.getElementById('upiSection');
        const paymentRefLabel = document.getElementById('paymentRefLabel');
        const upiHelp = document.getElementById('upiHelp');
        const codHelp = document.getElementById('codHelp');
        
        function toggleUPISection(){
            if (!pmSelect || !upiSection) return;
            const isUPI = (pmSelect.value === 'UPI');
            
            // Show/hide UPI section
            upiSection.style.display = isUPI ? 'block' : 'none';
            
            // Update payment reference label and help text
            if (isUPI) {
                paymentRefLabel.textContent = 'UPI Transaction Reference (Last 6 digits)';
                upiHelp.style.display = 'block';
                codHelp.style.display = 'none';
            } else {
                paymentRefLabel.textContent = 'Payment Reference (COD note)';
                upiHelp.style.display = 'none';
                codHelp.style.display = 'block';
            }
            
            // Calculate and update total amount
            updateTotalAmount();
        }
        
        pmSelect && pmSelect.addEventListener('change', toggleUPISection);
        toggleUPISection();
        
        // Calculate total amount based on cart quantities
        function updateTotalAmount() {
            let total = 0;
            document.querySelectorAll('.cart-qty input').forEach(function(input) {
                const qty = parseInt(input.value) || 0;
                const size = parseInt(input.getAttribute('data-size'));
                let price = 0;
                
                // Get price based on size
                if (size === 250) price = 349;
                else if (size === 500) price = 649;
                else if (size === 1000) price = 1299;
                
                total += qty * price;
            });
            
            document.getElementById('totalAmount').textContent = total;
        }
        
        // Update total when quantities change
        document.querySelectorAll('.cart-qty input').forEach(function(input) {
            input.addEventListener('input', updateTotalAmount);
        });

        // Ask location only when user interacts (e.g., when focusing address)
        const addressField = document.querySelector('[name="address_line1"]');
        const locStatus = document.getElementById('locStatus');
        const locTick = document.getElementById('locTick');
        const useMyLocation = document.getElementById('useMyLocation');
        function askGeo() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(function(pos){
                const lat = pos.coords.latitude.toFixed(6);
                const lng = pos.coords.longitude.toFixed(6);
                const latInput = document.querySelector('[name="latitude"]');
                const lngInput = document.querySelector('[name="longitude"]');
                if (latInput && !latInput.value) latInput.value = lat;
                if (lngInput && !lngInput.value) lngInput.value = lng;
                if (locStatus) locStatus.style.display = 'inline-block';
                if (locTick) locTick.style.display = 'inline-block';
            });
            addressField && addressField.removeEventListener('focus', askGeo);
        }
        addressField && addressField.addEventListener('focus', askGeo);

        // Manual trigger
        if (useMyLocation){
            useMyLocation.addEventListener('click', function(e){ e.preventDefault(); askGeo(); });
        }

        // Ensure location is captured before submit if possible
        const formEl = document.querySelector('form.order-form');
        if (formEl){
            formEl.addEventListener('submit', function(e){
                const latInput = document.querySelector('[name="latitude"]');
                const lngInput = document.querySelector('[name="longitude"]');
                const missing = !latInput.value || !lngInput.value;
                if (missing && navigator.geolocation){
                    e.preventDefault();
                    navigator.geolocation.getCurrentPosition(function(pos){
                        latInput.value = pos.coords.latitude.toFixed(6);
                        lngInput.value = pos.coords.longitude.toFixed(6);
                        if (locStatus) locStatus.style.display = 'inline-block';
                        if (locTick) locTick.style.display = 'inline-block';
                        formEl.submit();
                    }, function(){
                        formEl.submit();
                    });
                }
            });
        }
    </script>
</body>
</html>


